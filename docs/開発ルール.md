# 開発ルール

## 1. TDD (テスト駆動開発)

本プロジェクトはTDDで開発を進める。すべての機能実装・バグ修正において以下のサイクルを守ること。

### Red → Green → Refactor サイクル

```
1. Red:      失敗するテストを書く（期待する振る舞いを定義）
2. Green:    テストを通す最小限の実装を書く
3. Refactor: コードを整理する（テストが通ることを確認しながら）
```

### テスト粒度の指針

| レイヤー | テスト種別 | ツール | ファイル配置 |
|---------|-----------|-------|-------------|
| モデル | ユニットテスト | RSpec | `spec/models/` |
| サービス | ユニットテスト | RSpec | `spec/services/` |
| コントローラ | リクエストスペック | RSpec | `spec/requests/` |
| ジョブ | ユニットテスト | RSpec | `spec/jobs/` |
| ビュー統合 | システムスペック | RSpec + Playwright | `spec/system/` |
| E2Eシナリオ | E2Eテスト | Playwright | `e2e/` |

### テストの書き方

- **モデルスペック**: バリデーション、アソシエーション、スコープ、インスタンスメソッド
- **サービススペック**: 入出力の検証、エッジケース、エラーハンドリング
- **リクエストスペック**: HTTPステータス、レスポンスボディ、リダイレクト、認証
- **E2Eテスト**: ユーザーシナリオ（画面操作→結果確認の一連の流れ）

### テスト補助ツール

| gem/ツール | 用途 |
|-----------|------|
| `factory_bot_rails` | テストデータ生成 |
| `faker` | ダミーデータ生成 |
| `webmock` | 外部API呼び出しのスタブ |
| `vcr` | 外部APIレスポンスの記録・再生（必要に応じて） |
| `shoulda-matchers` | モデルテストの簡潔な記述 |
| `database_cleaner` | テストDB初期化 |

---

## 2. セキュリティ

### 秘密情報の管理

- **すべてのAPIキー・シークレット・認証情報は `.env` ファイルに記載する**
- `.env` は `.gitignore` に必ず含める
- `.env.example` をリポジトリに含め、必要なキー名を記載する（値は空欄）

```bash
# .env（gitignore対象 — 実際の値を記載）
DATABASE_URL=postgres://user:pass@localhost:5432/property_overview_dev
REDIS_URL=redis://localhost:6379/0

# .env.example（リポジトリに含める — キー名のみ）
DATABASE_URL=
REDIS_URL=
```

### 環境変数の参照ルール

```ruby
# OK: キーが未設定の場合にエラーで即座に気づける
ENV.fetch("DATABASE_URL")
ENV.fetch("API_KEY", "default_value")  # デフォルト値がある場合

# NG: nilが返りバグの原因になる
ENV["DATABASE_URL"]
```

### その他のセキュリティルール

- 個人情報を含むシードデータ・フィクスチャを作らない（FactoryBot + Fakerで生成）
- SQLインジェクション対策: ActiveRecordのクエリインターフェースを使う（生SQLを避ける）
- CSRF対策: Railsデフォルトのprotect_from_forgeryを無効化しない
- Strong Parameters: コントローラで必ずパラメータをフィルタリングする

---

## 3. コミット・プッシュルール

### コミット前の必須チェック

```bash
# 1. RSpecテスト全件パス
bundle exec rspec

# 2. Playwrightテスト全件パス
npx playwright test

# 3. RuboCop（静的解析）パス
bundle exec rubocop
```

**上記3つすべてがパスしない限り、コミット・プッシュしない。**

### コミットメッセージ

```
<プレフィックス>: <変更内容の要約>

<詳細説明（必要に応じて）>
```

| プレフィックス | 用途 | 例 |
|--------------|------|-----|
| `feat` | 新機能 | `feat: 物件登録のCRUDを実装` |
| `fix` | バグ修正 | `fix: 登記簿パーサーの地積抽出を修正` |
| `test` | テスト追加・修正 | `test: PropertyモデルのバリデーションSpecを追加` |
| `docs` | ドキュメント | `docs: 開発ルールを追加` |
| `refactor` | リファクタリング | `refactor: ZoneInfoFetcherのエラーハンドリングを整理` |
| `chore` | 設定・依存関係 | `chore: RuboCop設定を追加` |

### ブランチ運用

```
main                   ← 本番相当（直接pushしない）
├── feature/F01-property-crud    ← 機能開発
├── feature/F02-registration-parser
├── fix/lot-number-geocoding     ← バグ修正
└── chore/ci-setup               ← 設定系
```

- `main` への統合はPRを作成してマージする
- PRにはテストがすべてパスしていることを確認してからマージ

---

## 4. コーディング規約

### Ruby / Rails

- **RuboCop** に従う（プロジェクトルートの `.rubocop.yml` で設定）
- **コントローラは薄く**: ビジネスロジックはサービスオブジェクト (`app/services/`) に切り出す
- **Fat Model を避ける**: モデルが肥大化したらサービスに分離
- **N+1クエリ防止**: `includes` / `preload` を適切に使う
- **命名規則**:
  - モデル: 単数形 (`Property`, `RentRoll`)
  - テーブル: 複数形 (`properties`, `rent_rolls`)
  - サービス: 動詞+名詞 (`RegistrationPdfParser`, `StationFinder`)

### JavaScript (Stimulus)

- Stimulus controllerは1つの責務に限定する
- DOM操作はStimulusのtargets/valuesを使う（直接DOM操作を避ける）

### テストコード

- `describe` / `context` / `it` で構造化する
- `context` には条件を記述する（`"when ..."`、`"with ..."`）
- 1つの `it` で1つのアサーション（原則）
- テストの独立性を保つ（テスト間の依存を作らない）
