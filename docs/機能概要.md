# 物件概要書自動生成システム 設計概要

## 1. システム概要

土地・一棟収益不動産の売買における物件概要書を、各種PDFのアップロードと最小限の手入力で自動生成するWebアプリケーション。

**対象ユーザー**: 不動産仲介を行う個人事業主

---

## 2. 自動化可否の整理

### 自動化できるもの（システムが自動処理）

| 項目 | データソース | 自動化方法 |
|------|-------------|-----------|
| 用途地域 | 国土数値情報 | 緯度経度から自動判定 |
| 建ぺい率・容積率 | 国土数値情報 | 用途地域に紐づけて自動取得 |
| 最寄り駅・徒歩分数 | HeartRails Express API | 緯度経度から最寄り駅検索。徒歩分数は道路距離80m=1分で算出 |
| 広域地図 | 国土地理院タイル + Leaflet.js | 緯度経度から地図画像を自動生成。出典明記で無料商用利用可 |
| 登記簿情報の構造化 | Claude API（OCR/PDF解析） | 地番・地目・地積・構造・階数・築年月・所有者等を自動抽出 |
| 賃貸借契約書→レントロール変換 | Claude API（PDF解析） | 号室・用途・面積・賃料・共益費・契約期間等を自動抽出し一覧化 |
| 地番→緯度経度変換 | 登記所備付地図データ（14条地図） | 地番ポリゴンデータから位置情報を取得 |

### 自動化できないもの（ユーザーによるアップロードまたは手入力）

| 項目 | 入力方法 | 備考 |
|------|---------|------|
| 売買価格 | 手入力 | - |
| 登記簿謄本 | PDFアップロード | 登記情報提供サービスから取得したPDF |
| 賃貸借契約書 | PDFアップロード | 1件ずつ or 複数まとめて1PDF、両方対応 |
| ゼンリン地図（詳細地図） | PDF/画像アップロード | ZENRIN Maps APIは法人向け（初期36万円・月額6万円〜）のため非現実的 |
| 路線価図 | PDF/画像アップロード | 国税庁サイトから取得したPDFまたはスクリーンショット |
| 建物図面 | PDF/画像アップロード | 売主やPMから入手した資料 |
| 修繕履歴 | フォーム入力 or Excelアップロード | 修繕年月・内容・金額を構造化入力 |
| 空室情報 | 手入力 | 契約書がない部屋=空室のため、号室と面積を手入力 |

---

## 3. 機能一覧

### F01: 物件登録
- 物件名称、所在地（住居表示）の入力
- 売買価格の入力
- 物件種別の選択（土地のみ / 土地+建物）

### F02: 登記簿PDF解析
- 土地・建物の登記簿謄本PDFアップロード
- Claude APIによる自動解析
- 抽出項目: 所在・地番、地目、地積、建物構造、階数、床面積、築年月日、所有者情報、抵当権等
- 解析結果の確認・修正画面

### F03: 地番→位置情報変換
- 登記簿から抽出した地番を14条地図データで緯度経度に変換
- 変換結果の地図上での確認

### F04: 地域情報自動取得
- 緯度経度から以下を自動取得
  - 用途地域
  - 建ぺい率
  - 容積率
  - 最寄り駅・徒歩分数
  - 広域地図画像

### F05: 賃貸借契約書→レントロール変換
- 賃貸借契約書PDFアップロード（単体 or 複数まとめて対応）
- Claude APIによる契約ごとの分離・解析
- 抽出項目: 号室、テナント名、用途、契約面積、賃料、共益費、敷金/保証金、契約期間、更新区分
- 空室の手動追加機能
- 解析結果の確認・修正画面（一覧表形式）

### F06: 添付資料アップロード
- ゼンリン地図（PDF/画像）
- 路線価図（PDF/画像）
- 建物図面（PDF/画像）
- その他任意の添付資料

### F07: 修繕履歴入力
- フォーム入力: 修繕年月、工事内容、施工箇所、金額
- Excelファイルからのインポート機能

### F08: 概要書プレビュー・PDF出力
- 全データを統合してプレビュー表示
- ページ構成のカスタマイズ（順序変更・ページ削除）
- PDF出力・ダウンロード

### F09: 物件データ管理
- 作成済み物件の一覧・検索
- 物件データの編集・更新
- 概要書の再出力

---

## 4. 画面一覧

| 画面ID | 画面名 | 概要 |
|--------|--------|------|
| S01 | ダッシュボード | 作成済み物件一覧、新規作成ボタン |
| S02 | 物件基本情報入力 | 物件名称・所在地・売買価格・物件種別の入力 |
| S03 | 登記簿アップロード | 土地/建物の登記簿PDFアップロード画面 |
| S04 | 登記簿解析結果確認 | Claude APIの解析結果の確認・修正。項目ごとの編集フォーム |
| S05 | 地図・位置情報確認 | 地番→緯度経度変換結果の地図表示。位置の手動補正機能 |
| S06 | 地域情報確認 | 用途地域・建ぺい率・容積率・最寄り駅の自動取得結果の確認・修正 |
| S07 | 賃貸借契約書アップロード | 契約書PDFのアップロード画面（複数ファイル対応） |
| S08 | レントロール確認・編集 | 解析結果のレントロール一覧表。行の追加・修正・削除。空室追加 |
| S09 | 添付資料アップロード | ゼンリン地図・路線価図・建物図面等のアップロード画面 |
| S10 | 修繕履歴入力 | 修繕履歴のフォーム入力 or Excelインポート画面 |
| S11 | 概要書プレビュー | 生成された概要書のプレビュー表示。ページ順の変更・出力設定 |
| S12 | PDF出力・ダウンロード | PDF生成・ダウンロード画面 |

---

## 5. 出力される概要書のページ構成

| ページ | 内容 |
|--------|------|
| 1 | 物件概要（物件名・売買価格・所在地・地目・地積・用途地域・建ぺい率・容積率・最寄り駅・徒歩分数） |
| 2 | 土地の登記簿情報サマリー（所有権・権利関係含む） |
| 3 | 建物の登記簿情報サマリー（構造・階数・床面積・築年月）※建物がある場合 |
| 4 | 広域地図 |
| 5 | 詳細地図（ゼンリン地図） |
| 6 | 建物図面 ※建物がある場合 |
| 7 | レントロール（賃貸借一覧表）※収益物件の場合 |
| 8 | 修繕履歴 ※建物がある場合 |
| 9 | 路線価図 |

---

## 6. 処理フロー

```
[ユーザー操作]                    [システム処理]
     |                                |
  物件基本情報入力 ──────────────→ 物件レコード作成
     |                                |
  登記簿PDFアップロード ────────→ Claude APIで解析
     |                              → 地番・建物情報を構造化
     |                              → 14条地図データで緯度経度変換
     |                              → 用途地域・建ぺい率・容積率を自動取得
     |                              → 最寄り駅・徒歩分数を自動取得
     |                              → 広域地図画像を自動生成
     |                                |
  解析結果を確認・修正 ─────────→ 確定データとして保存
     |                                |
  賃貸借契約書PDFアップロード ──→ Claude APIで解析
     |                              → 契約ごとに分離・構造化
     |                                |
  レントロール確認・空室追加 ───→ レントロール確定
     |                                |
  ゼンリン地図アップロード          |
  路線価図アップロード              |
  建物図面アップロード              |
  修繕履歴入力                      |
     |                                |
  概要書プレビュー ─────────────→ 全データ統合・テンプレート適用
     |                                |
  PDF出力 ──────────────────────→ PDF生成・ダウンロード
```

---

## 7. 技術スタック（案）

| レイヤー | 技術 | 備考 |
|---------|------|------|
| バックエンド | Ruby on Rails | 物件データ管理、PDF生成、API連携 |
| フロントエンド | Hotwire (Turbo + Stimulus) | Rails標準のSPA的UX |
| データベース | PostgreSQL + PostGIS | 位置情報の空間クエリ対応 |
| PDF解析 | Anthropic Claude API | 登記簿・賃貸借契約書の構造化 |
| 地図表示 | 国土地理院タイル + Leaflet.js | 広域地図画像生成（無料・出典明記で商用利用可） |
| 最寄り駅検索 | HeartRails Express API | 緯度経度→最寄り駅+距離（無料） |
| ジオコーディング | 国土地理院ジオコーディングAPI | 住所→緯度経度変換（無料・登録不要） |
| 地域情報 | 国土数値情報（GISデータ） | 用途地域・建ぺい率・容積率 |
| 地番変換 | 14条地図データ | 地番→緯度経度変換 |
| PDF生成 | Prawn or wicked_pdf | 概要書のPDF出力 |
| ファイルストレージ | AWS S3 or Google Cloud Storage | アップロードファイルの保存 |
| ホスティング | Heroku or Render | 小規模運用向け |

---

## 8. 外部API・データソースの利用料金目安

| サービス | 料金 | 備考 |
|---------|------|------|
| Anthropic Claude API | 従量課金（Sonnet: 入力$3/出力$15 per 1M tokens程度） | 登記簿・契約書解析に使用 |
| 国土地理院タイル | 無料 | 広域地図画像。出典明記で商用・印刷利用可 |
| HeartRails Express API | 無料 | 最寄り駅検索。クレジット表示が条件 |
| 国土地理院ジオコーディングAPI | 無料 | 住所→緯度経度変換。登録不要 |
| 国土数値情報 | 無料 | 用途地域データのダウンロード |
| 14条地図データ | 無料（法務局オープンデータ） | 地番→位置変換 |
| 登記情報提供サービス | 1件あたり300〜400円程度 | ユーザーが自分で取得（システム外） |

---

## 9. PDF解析のアプローチ

### 登記簿謄本: ルールベースの自前パーサー（API不要）

登記情報提供サービスから取得するPDFはスキャン画像ではなくテキスト埋め込み型のため、OCR不要でテキスト抽出が可能。さらに法務局の統一フォーマットに準拠しているため、ルールベースのパーサーで構造化できる。

**抽出対象**
- 表題部（土地）: 所在、地番、地目、地積
- 表題部（建物）: 所在、家屋番号、種類、構造、階数、床面積、新築年月日
- 権利部（甲区）: 所有権に関する事項（所有者名、登記原因・日付）
- 権利部（乙区）: 抵当権・根抵当権等（債権額、債務者、抵当権者）

**技術アプローチ**
- pdfplumber等でPDFからテキスト抽出
- 正規表現とテキストパースで項目を構造化
- 表題部→権利部（甲区）→権利部（乙区）のセクション分割は「表題部」「権利部（甲区）」等の固定文字列で判定

**メリット**
- 外部API不要のためランニングコストゼロ
- 処理速度が速い（API呼び出しの待ち時間なし）
- オフライン環境でも動作可能

**リスク・注意点**
- 登記簿の記載パターンに例外的なケースがある場合、パーサーの修正が必要
- 共同担保目録や信託目録など、複雑なケースの対応は段階的に追加
- パーサーで読み取れなかった場合のフォールバックとして手動入力画面を用意

### 賃貸借契約書: Claude API（AI解析）

賃貸借契約書は管理会社・大家ごとにフォーマットがバラバラで、スキャンPDF（画像）の場合もあるため、ルールベースでの対応は非現実的。Claude APIのドキュメント解析機能を使用する。

**抽出対象**
- 号室（部屋番号）
- テナント名（個人名の匿名化要検討）
- 用途（住居・事務所・店舗等）
- 契約面積
- 賃料（月額）
- 共益費・管理費
- 敷金・保証金
- 契約期間（開始日・終了日）
- 更新区分（普通借家・定期借家）

**処理方式**
- 単体PDF: そのまま解析
- 複数契約まとめPDF: 「賃貸借契約書」等のヘッダーを境界として契約単位に分離して解析
- 解析結果は必ずユーザー確認ステップを経てから確定

---

## 10. Claude API利用コストの詳細

### 前提: Claude.aiのProプランとAPIは完全に別サービス

- Claude.ai Proプラン（月額$20）に加入していても、APIの利用料は別途発生する
- APIはAnthropic Console（console.anthropic.com）で別途アカウント作成・APIキー発行が必要
- APIは純粋な従量課金（使った分だけ）

### コスト試算

| モデル | 入力単価 | 出力単価 |
|--------|---------|---------|
| Claude Sonnet 4 | $3 / 1Mトークン | $15 / 1Mトークン |

**賃貸借契約書1件あたりの目安**
- 入力トークン: 約2,000〜5,000（契約書のテキスト量による）
- 出力トークン: 約300〜500（構造化データ）
- 1件あたりコスト: 約1〜3円

**一棟収益物件（20部屋）の場合**
- 賃貸借契約書20件の解析: 約20〜60円
- 登記簿はルールベースのため: 0円
- **1物件あたり合計: 数十円程度**

### コスト最適化策
- 登記簿を自前パーサーにすることで、最も処理回数が多い部分のAPI費用をゼロに
- 賃貸借契約書のみClaude APIを使用することで、ランニングコストを最小限に抑制
- 将来的にローカルLLM（Ollama等）での代替も検討可能

---

## 11. 開発上の注意点・リスク

- **登記簿PDFの解析精度**: Claude APIの精度は高いが、100%ではない。必ず確認・修正ステップを設ける
- **14条地図データの網羅性**: 全国すべての地番がカバーされているわけではない。変換できなかった場合の手動入力フォールバックが必要
- **賃貸借契約書のフォーマット多様性**: 物件・管理会社によって書式がバラバラ。Claude APIのプロンプト設計が重要
- **個人情報の取り扱い**: 登記簿や契約書には個人情報が含まれるため、適切なデータ管理とプライバシーポリシーが必要
- **ゼンリン地図の著作権**: アップロードされたゼンリン地図を概要書に貼り付ける際の著作権・利用規約の確認が必要