# 物件概要書自動生成システム — Rails開発計画

## 前提

- **フレームワーク**: Ruby on Rails 8.1 (Hotwire標準)
- **Ruby**: 4.0
- **DB**: PostgreSQL 16 + PostGIS
- **本番環境**: Render（小規模PoCに適する）
- **開発環境**: Docker Compose（PostgreSQL/PostGIS + Redis）
- **対象ユーザー**: 個人事業主1名（認証はシンプルに）

---

## フェーズ0: プロジェクト初期セットアップ

### 0-1. Rails プロジェクト生成
```
rails new property-overview-poc --database=postgresql --css=tailwind --skip-jbuilder
```
- Tailwind CSS（UIを素早く構築）
- Hotwire（Turbo + Stimulus）はRails 8標準で同梱
- Rails 8標準の認証機能（`rails generate authentication`）を使用（Devise不要）
- Solid Queue（Rails 8標準のジョブバックエンド、Sidekiq/Redis不要）
- Solid Cable（Rails 8標準のActionCableアダプタ、Redis不要）

### 0-2. 追加gemの導入
| gem | 用途 |
|-----|------|
| `activerecord-postgis-adapter` | PostGIS連携 |
| `rgeo` / `rgeo-geojson` | GISデータ操作 |
| `pdf-reader` | PDFテキスト抽出（登記簿パーサー） |
| `prawn` + `prawn-table` | PDF生成 |
| `leaflet-rails` or CDN | 国土地理院タイルによる地図表示 |
| `faraday` | 外部API呼び出し |
| `roo` | Excelインポート（レントロール・修繕履歴） |
| `rspec-rails` | テストフレームワーク |
| `factory_bot_rails` | テストデータ生成 |
| `webmock` | 外部APIスタブ |
| `shoulda-matchers` | モデルテスト簡潔化 |

※ `active_storage`, `image_processing`, `solid_queue`, `solid_cable` はRails 8標準同梱

### 0-3. Docker Compose
- PostgreSQL + PostGIS
- ※ Redis不要（Solid Queue / Solid CableはDB利用のためRedis依存なし）

### 0-4. CI設定
- GitHub Actions: RuboCop + RSpec

---

## フェーズ1: データモデル・基本CRUD（物件登録 — F01/F09）

### データベース設計

```ruby
# properties（物件）
create_table :properties do |t|
  t.string :name, null: false                   # 物件名称
  t.string :address, null: false                 # 所在地（住居表示）
  t.decimal :sale_price, precision: 15, scale: 0 # 売買価格
  t.integer :property_type, default: 0           # enum: land_only / land_and_building
  t.st_point :location, geographic: true         # 緯度経度（PostGIS）
  t.integer :status, default: 0                  # enum: draft / completed
  t.timestamps
end

# land_registrations（土地登記情報）
create_table :land_registrations do |t|
  t.references :property, null: false, foreign_key: true
  t.string :location_address    # 所在
  t.string :lot_number          # 地番
  t.string :land_category       # 地目
  t.decimal :land_area           # 地積（㎡）
  t.jsonb :ownership_info        # 甲区（所有権情報）
  t.jsonb :mortgage_info         # 乙区（抵当権等）
  t.jsonb :raw_parsed_data       # パーサー生データ（デバッグ用）
  t.timestamps
end

# building_registrations（建物登記情報）
create_table :building_registrations do |t|
  t.references :property, null: false, foreign_key: true
  t.string :location_address    # 所在
  t.string :building_number     # 家屋番号
  t.string :building_type       # 種類
  t.string :structure           # 構造
  t.integer :floors             # 階数
  t.jsonb :floor_areas          # 各階床面積
  t.date :construction_date     # 新築年月日
  t.jsonb :ownership_info
  t.jsonb :mortgage_info
  t.jsonb :raw_parsed_data
  t.timestamps
end

# rent_rolls（レントロール）
create_table :rent_rolls do |t|
  t.references :property, null: false, foreign_key: true
  t.string :room_number         # 号室
  t.string :tenant_name         # テナント名
  t.string :usage_type          # 用途（住居/事務所/店舗）
  t.decimal :contract_area      # 契約面積
  t.integer :monthly_rent       # 賃料（月額）
  t.integer :common_fee         # 共益費
  t.integer :deposit            # 敷金/保証金
  t.date :contract_start        # 契約開始日
  t.date :contract_end          # 契約終了日
  t.integer :renewal_type       # 更新区分（普通借家/定期借家）
  t.boolean :vacant, default: false  # 空室フラグ
  t.timestamps
end

# zone_infos（地域情報）
create_table :zone_infos do |t|
  t.references :property, null: false, foreign_key: true
  t.string :use_district        # 用途地域
  t.decimal :building_coverage  # 建ぺい率
  t.decimal :floor_area_ratio   # 容積率
  t.string :nearest_station     # 最寄り駅
  t.integer :walking_minutes    # 徒歩分数
  t.timestamps
end

# attachments（添付資料） → ActiveStorageで管理
# - 広域地図（自動生成）
# - ゼンリン地図
# - 路線価図
# - 建物図面
# - 登記簿PDF原本
# - 賃貸借契約書PDF原本

# repair_histories（修繕履歴）
create_table :repair_histories do |t|
  t.references :property, null: false, foreign_key: true
  t.date :repair_date           # 修繕年月
  t.string :description         # 工事内容
  t.string :repair_location     # 施工箇所
  t.integer :cost               # 金額
  t.timestamps
end

# documents（生成済みPDF管理）
create_table :documents do |t|
  t.references :property, null: false, foreign_key: true
  t.jsonb :page_config          # ページ構成・順序
  t.integer :version, default: 1
  t.timestamps
end
```

### 実装内容
- Property の CRUD（S01ダッシュボード、S02基本情報入力）
- Rails 8標準の認証機能（`rails generate authentication`）で簡易認証
- ダッシュボードに物件一覧表示（Turbo Frames でページネーション）

---

## フェーズ2: 登記簿PDFパーサー（F02）

### 実装内容
- `app/services/registration_pdf_parser.rb` — ルールベースパーサー
  - `pdf-reader` gem でPDFからテキスト抽出
  - 正規表現で表題部・甲区・乙区をセクション分割
  - 各セクション内を正規表現で構造化
- `app/jobs/parse_registration_job.rb` — Solid Queueジョブ
  - アップロード → 非同期解析 → Turbo Streamで結果を画面反映
- S03（アップロード画面）、S04（解析結果確認・修正画面）
- パーサー失敗時の手動入力フォールバック

### テスト戦略
- 実際の登記簿PDFサンプル（個人情報マスク済み）を fixtures に配置
- パーサーのユニットテスト（各セクション分割・項目抽出）
- 例外パターンは段階的に追加

---

## フェーズ3: 地番→位置情報変換 + 地域情報取得（F03/F04）

### 3-1. 14条地図データの準備
- 法務局オープンデータのGeoJSONを取得
- PostGISに地番ポリゴンデータをインポート（rake タスク）
- 地番文字列 → ポリゴン検索 → centroid（重心）で緯度経度取得

```ruby
# app/services/lot_number_geocoder.rb
class LotNumberGeocoder
  def geocode(prefecture, city, lot_number)
    # PostGISの空間クエリで地番ポリゴンを検索
    # ST_Centroid でポリゴンの重心を緯度経度として返す
  end
end
```

### 3-2. 地域情報自動取得
- **用途地域・建ぺい率・容積率**: 国土数値情報GISデータをPostGISにインポート → 緯度経度で空間クエリ
- **最寄り駅検索**: HeartRails Express API（無料、緯度経度→最寄り駅+直線距離）
- **徒歩分数算出**: 道路距離80m=1分（不動産公正取引協議会基準）で自前計算
  - HeartRailsの直線距離 × 1.3倍 で道路距離を推定
  - 最終的にはユーザーが確認・修正するワークフロー
- **広域地図画像**: 国土地理院タイル + Leaflet.js で地図表示 → html2canvasで画像化しActiveStorageに保存
  - タイルURL: `https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png`
  - 出典「国土地理院」を地図上に明記（利用規約要件）

```ruby
# app/services/zone_info_fetcher.rb       # 用途地域・建ぺい率・容積率（PostGIS空間クエリ）
# app/services/station_finder.rb          # HeartRails Express API → 最寄り駅+徒歩分数
# app/services/map_image_generator.rb     # 国土地理院タイル → 広域地図画像生成
```

### 3-3. ジオコーディング（住所→緯度経度フォールバック）
- 14条地図データで地番→緯度経度が取得できなかった場合
- 国土地理院ジオコーディングAPI（無料・登録不要）を使用
  - エンドポイント: `https://msearch.gsi.go.jp/address-search/AddressSearch?q=住所文字列`

### 3-4. 画面
- S05（地図・位置情報確認）— Stimulus + Leaflet.js + 国土地理院タイルで地図表示・位置補正
- S06（地域情報確認・修正）

---

## フェーズ4: レントロール手動入力（F05）

### 実装内容
- S08（レントロール入力・編集画面）
  - 一覧表形式のフォーム（Turbo Framesで行単位の編集）
  - 行の動的追加・削除（Stimulus）
  - 入力項目: 号室、テナント名、用途、契約面積、賃料、共益費、敷金/保証金、契約期間、更新区分
  - 空室行の追加（空室フラグON、テナント名・賃料等は空欄）
  - 合計行の自動計算表示（賃料合計、共益費合計、稼働率）
  - Excelインポート機能（`roo` gem）— 既存のレントロールExcelがある場合に対応

※ 将来的にClaude APIによる賃貸借契約書PDF解析を追加可能な設計にしておく（rent_rollsテーブルは同一）

---

## フェーズ5: 添付資料・修繕履歴（F06/F07）

### 実装内容
- S09（添付資料アップロード）
  - ActiveStorage による複数ファイルアップロード
  - ファイル種別: ゼンリン地図 / 路線価図 / 建物図面 / その他
  - ドラッグ&ドロップ対応（Stimulus）
  - プレビュー表示
- S10（修繕履歴入力）
  - フォーム入力（動的行追加 — Stimulus）
  - Excelインポート（`roo` gem でxlsx読み込み）

---

## フェーズ6: 概要書プレビュー・PDF出力（F08）

### 実装内容
- S11（概要書プレビュー）
  - 全データを統合してHTML形式でプレビュー
  - ページ順序のドラッグ&ドロップ並び替え（Stimulus + SortableJS）
  - ページの表示/非表示切り替え
- S12（PDF出力）
  - `prawn` + `prawn-table` でPDF生成
  - ページ構成（§5参照）に従い各ページを組み立て
  - 画像の埋め込み（地図・図面等）
  - `app/services/overview_pdf_generator.rb`
  - 生成は非同期ジョブ → 完了後ダウンロードリンクを Turbo Stream で表示

### PDF構成

```ruby
# app/services/overview_pdf_generator.rb
class OverviewPdfGenerator
  PAGES = %i[
    property_summary        # P1: 物件概要
    land_registration       # P2: 土地登記情報
    building_registration   # P3: 建物登記情報
    wide_area_map           # P4: 広域地図
    detail_map              # P5: 詳細地図（ゼンリン）
    building_plan           # P6: 建物図面
    rent_roll               # P7: レントロール
    repair_history          # P8: 修繕履歴
    route_price_map         # P9: 路線価図
  ].freeze

  def generate(property, page_config)
    # page_configに基づいてページを組み立て
  end
end
```

---

## フェーズ別スコープまとめ

| フェーズ | 内容 | 機能ID | 主な画面 |
|---------|------|--------|---------|
| 0 | プロジェクトセットアップ | - | - |
| 1 | 物件CRUD・認証・ダッシュボード | F01, F09 | S01, S02 |
| 2 | 登記簿PDFパーサー | F02 | S03, S04 |
| 3 | 地番→位置変換・地域情報取得 | F03, F04 | S05, S06 |
| 4 | レントロール手動入力 | F05 | S08 |
| 5 | 添付資料・修繕履歴 | F06, F07 | S09, S10 |
| 6 | 概要書プレビュー・PDF出力 | F08 | S11, S12 |

---

## GISデータの事前準備（フェーズ3の前提作業）

### 14条地図データ
- ダウンロード元: https://front.geospatial.jp/ （登記所備付地図データ）
- 形式: GeoJSON
- インポート: `ogr2ogr` で PostGIS にロード

```bash
ogr2ogr -f "PostgreSQL" PG:"dbname=property_overview_dev" \
  -nln lot_polygons -overwrite 14map_data.geojson
```

### 国土数値情報（用途地域）
- ダウンロード元: https://nlftp.mlit.go.jp/ksj/
- 形式: Shapefile
- インポート: `shp2pgsql` で PostGIS にロード

```bash
shp2pgsql -s 4326 A29-11_XX.shp use_districts | psql -d property_overview_dev
```

---

## ディレクトリ構成（主要部分）

```
app/
├── controllers/
│   ├── properties_controller.rb
│   ├── land_registrations_controller.rb
│   ├── building_registrations_controller.rb
│   ├── rent_rolls_controller.rb
│   ├── attachments_controller.rb
│   ├── repair_histories_controller.rb
│   └── documents_controller.rb
├── models/
│   ├── property.rb
│   ├── land_registration.rb
│   ├── building_registration.rb
│   ├── rent_roll.rb
│   ├── zone_info.rb
│   ├── repair_history.rb
│   └── document.rb
├── services/
│   ├── registration_pdf_parser.rb       # 登記簿パーサー
│   ├── lot_number_geocoder.rb           # 地番→緯度経度
│   ├── zone_info_fetcher.rb             # 用途地域・建ぺい率・容積率
│   ├── station_finder.rb               # 最寄り駅検索
│   ├── map_image_generator.rb           # 広域地図画像生成
│   └── overview_pdf_generator.rb        # 概要書PDF生成
├── jobs/
│   ├── parse_registration_job.rb
│   ├── fetch_zone_info_job.rb
│   └── generate_pdf_job.rb
├── views/
│   ├── properties/
│   ├── land_registrations/
│   ├── rent_rolls/
│   └── documents/
└── javascript/
    └── controllers/                     # Stimulus controllers
        ├── map_controller.js            # Leaflet.js+国土地理院タイル 地図表示・位置補正
        ├── file_upload_controller.js    # D&Dアップロード
        ├── sortable_controller.js       # ページ順序並び替え
        └── dynamic_form_controller.js   # 動的行追加
```

---

## リスクと対策

| リスク | 対策 |
|--------|------|
| 登記簿PDFのフォーマット例外 | パーサー失敗時は手動入力にフォールバック。例外パターンを蓄積してパーサーを改善 |
| 14条地図データに地番がない | 手動で住所入力 → 国土地理院ジオコーディングAPIで緯度経度取得するフォールバック |
| GISデータのサイズ | 対象エリアを限定してインポート（全国一括は不要。対象都道府県のみ） |
| PDF生成の品質 | Prawnで難しければ、HTML→PDF（wicked_pdf / Grover）に切り替え |
